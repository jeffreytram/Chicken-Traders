{% extends 'layout.html' %}
{% block content %}
<div class="all-container">
    <!-- top bar UI -->
    <div class="player-info-grid">
        <div>
            <img class="item-icon player-info" src="../static/item-images/icon-credits.svg">
            <div id="credits" class="player-info">{{game.player.credit}}</div>
        </div>
        <div>
            <img class="item-icon player-info" src="../static/item-images/icon-fuel.svg">
            <div id="fuel" class="player-info">{{game.player.ship.fuel_level}}</div>
            <div class="player-info">/ {{game.player.ship.max_fuel}}</div>
        </div>
        <div>
            <img class="item-icon player-info" src="../static/item-images/icon-health.svg">
            <div id="health" class="player-info">{{game.player.ship.health_level}}</div>
            <div class="player-info">/ {{game.player.ship.max_health}}</div>
        </div>
    </div>

    <!-- nav bar -->
    <div id="menu">
        <button id="travel" onclick="location.href = 'travel'">Travel</button>
        <button id="market" onclick="location.href = 'market'">Market</button>
        <button id="ship" onclick="location.href = 'ship'">Ship</button>
        <button id="collection" onclick="location.href = 'collection'">Collection</button>
        <button id="stats" class="active" onclick="location.href = 'stats'">Stats</button>
    </div>
    <h2 id="header">Stats</h2>
</div>
    <div class="stats-container">
        <div class="side-chart">
            <div class="svg-container">
                <svg id="earnings"></svg>
            </div>
            <div class="svg-container">
                <svg id="expenses"></svg>
            </div>
        </div>
        <div class="main-chart">
            <svg id="net-worth"></svg>
        </div>
        <div class="stats-grid">
            <div>items purchased: <span id="num-purchased"></span></div>
            <div>fuel purchased: <span></span></div>
            <div>NPC encounters: <span></span></div>

            <div>items sold: <span id="num-sold"></span></div>
            <div>repairs purchased: <span></span></div>
            <div>distance traveled: <span></span></div>

            <div>transactions: <span id="num-transactions"></span></div>
            <div>favorite item: <span></span></div>
            <div># other stat stuff<span></span></div>
        </div>
    </div>
<script>
    let transactionHistory = {{ transaction_history | tojson }};
    transactionHistory.forEach(function (entry, i) {
        transactionHistory[i] = JSON.parse(entry);
    });
    console.log(transactionHistory);

    function getTotalNumberItemsSold() {
        let items = transactionHistory.filter(entry => entry.category === "trade" && entry.transaction_type === "earnings");
        document.getElementById('num-sold').innerHTML = items.length;
    }

    function getNumberTransactions() {
        document.getElementById('num-transactions').innerHTML = transactionHistory.length;
    }

    function getTotalNumberItemsPurchased() {
        let items = transactionHistory.filter(entry => entry.category === "trade" && entry.transaction_type === "expenses");
        document.getElementById('num-purchased').innerHTML = items.length;
    }
    function loadEarningsChart() {
        let earnings = transactionHistory.filter(entry => entry.transaction_type === "earnings");
        let categories = [
            {name: "trade", total: 0, color: "green"},
            {name: "loot", total: 0, color: "orange"},
            {name: "collection", total: 0, color: "red"}
        ];
        let total = 0;
        earnings.forEach(function(entry, i) {
            total += entry.price;
            if (entry.category === "trade") {
                categories[0].total += entry.price;
            } else if (entry.category === "loot") {
                categories[1].total += entry.price;
            } else if (entry.category === "collection") {
                categories[2].total += entry.price;
            }
        });
        
        const width = 300;
        const height = 150;
        const radius = Math.min(width, 2 * height) / 2;
        const thickness = 30;

        let pie = d3.pie()
            .value(function(entry) {
                return entry.total;
            })
            .sort(null)
            .startAngle(-90 * (Math.PI / 180))
            .endAngle(90 * (Math.PI / 180));

        let arc = d3.arc()
            .outerRadius(radius)
            .innerRadius(radius - thickness)

        let translation = (x, y) => `translate(${x}, ${y})`;

        let svg = d3.select('#earnings')
            .attr('width', width)
            .attr('height', height)
            .attr('viewBox', [0, 0, width, height])
            .attr('preserveAspectRatio', 'xMidYMid meet')
            .attr('class', 'half-donut')
            .append('g')
            .attr('transform', translation(width / 2, height));

        const div = d3.select('body').append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0);
        
        svg.selectAll('path')
            .data(pie(categories))
            .enter()
            .append('path')
            .attr('d', arc)
            .attr('fill', (entry) => entry.data.color)
            .on('mouseover', (entry) => {
                let percentage = entry.data.total * 100 / total;
                div.html(`${percentage.toFixed(1)}%: ${entry.data.name}<br>$${entry.data.total}`)
                  .style('opacity', 0.85)
                  .style('font-weight', 'bold')
                  .style('left', `${d3.event.pageX - 45}px`)
                  .style('top', `${d3.event.pageY - 40}px`);
              })
            .on('mouseout', () => {
                div.style('opacity', 0);
            });

        svg.append('text')
            .text('$' + total)
            .attr('dy', '-3rem')
            .attr('class', 'label')
            .attr('text-anchor', 'middle');

        svg.append('text')
            .text('earnings')
            .attr('dy', '-1rem')
            .attr('class', 'label')
            .attr('text-anchor', 'middle');
    }

    function loadExpensesChart() {
        let expenses = transactionHistory.filter(entry => entry.transaction_type == "expenses");
        let categories = [
            {name: "trade", total: 0, color: "green"},
            {name: "fees", total: 0, color: "yellow"},
            {name: "fuel", total: 0, color: "red"},
            {name: "repairs", total: 0, color: "blue"}
        ];
        let total = 0;
        expenses.forEach(function(entry, i) {
            total += entry.price;
            if (entry.category === "trade") {
                categories[0].total += entry.price;
            } else if (entry.category === "fees") {
                categories[1].total += entry.price;
            } else if (entry.category === "fuel") {
                categories[2].total += entry.price;
            } else if (entry.category === "repairs") {
                categories[3].total += entry.price;
            }
        });
        
        const width = 300;
        const height = 150;
        const radius = Math.min(width, 2 * height) / 2;
        const thickness = 30;

        let pie = d3.pie()
            .value(function(entry) {
                return entry.total;
            })
            .sort(null)
            .startAngle(-90 * (Math.PI / 180))
            .endAngle(90 * (Math.PI / 180));

        let arc = d3.arc()
            .outerRadius(radius)
            .innerRadius(radius - thickness)

        let translation = (x, y) => `translate(${x}, ${y})`;

        let svg = d3.select('#expenses')
            .attr('width', width)
            .attr('height', height)
            .attr('viewBox', [0, 0, width, height])
            .attr('preserveAspectRatio', 'xMidYMid meet')
            .attr('class', 'half-donut')
            .append('g')
            .attr('transform', translation(width / 2, height));

        const div = d3.select('body').append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0);

        svg.selectAll('path')
            .data(pie(categories))
            .enter()
            .append('path')
            .attr('d', arc)
            .attr('fill', (entry) => entry.data.color)
            .on('mouseover', (entry) => {
                let percentage = entry.data.total * 100 / total;
                div.html(`${percentage.toFixed(1)}%: ${entry.data.name}<br>$${entry.data.total}`)
                  .style('opacity', 0.85)
                  .style('font-weight', 'bold')
                  .style('left', `${d3.event.pageX - 45}px`)
                  .style('top', `${d3.event.pageY - 40}px`);
              })
            .on('mouseout', () => {
                div.style('opacity', 0);
            });

        svg.append('text')
            .text('$' + total)
            .attr('dy', '-3rem')
            .attr('class', 'label')
            .attr('text-anchor', 'middle');

        svg.append('text')
            .text('expenses')
            .attr('dy', '-1rem')
            .attr('class', 'label')
            .attr('text-anchor', 'middle');
        
    }

    function loadNetWorthChart() {
        const rawNetWorthData = {{ net_worth_data }};

        //formatting the data
        let netWorthData = [];
        rawNetWorthData.forEach(function (entry, i) {
            netWorthData.push({ day: i / 12, amount: rawNetWorthData[i] })
        });

        const width = 540;
        const height = 400;

        //getting svg
        const svg = d3.select('#net-worth')
            .attr('viewBox', `0 0 ${width} ${height}`);

        const render = data => {
            const xValue = d => d.day;
            const yValue = d => d.amount;
            const margin = { top: 30, right: 20, bottom: 60, left: 100 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const xScale = d3.scaleLinear()
                .domain([0, (netWorthData.length - 1) / 12])
                .range([0, innerWidth]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(netWorthData, yValue)])
                .range([innerHeight, 0]);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);

            //x axis
            const xAxis = d3.axisBottom(xScale)
                .ticks(4);
            const xAxisG = g.append('g').call(xAxis)
                .attr('transform', `translate(0, ${innerHeight})`);
            xAxisG.append('text')
                .attr('x', innerWidth / 2)
                .attr('y', 50)
                .attr('fill', 'black')
                .attr('font-weight', 'bold')
                .text('Day');

            //y axis
            const yAxis = d3.axisLeft(yScale)
            const yAxisG = g.append('g').call(yAxis)
            yAxisG.append('text')
                .attr('x', -50)
                .attr('y', innerHeight / 2)
                .attr('fill', 'black')
                .attr('font-weight', 'bold')
                .text('Credits');
            
            g.append('text')
                .attr('x', innerWidth / 2)
                .attr('y', 0)
                .attr('fill', 'black')
                .text('Estimated Net Worth Over Time')
                .attr('text-anchor', 'middle');

            //Line Graph
            g.append('path').datum(netWorthData)
                .attr('fill', 'none')
                .attr('stroke', 'steelblue')
                .attr('stroke-width', 1.5)
                .attr('d', d3.line()
                    .x(d => xScale(xValue(d)))
                    .y(d => yScale(yValue(d)))
                );
        };
        render(netWorthData);
    }
    loadEarningsChart();
    loadExpensesChart();
    loadNetWorthChart();
    getTotalNumberItemsPurchased();
    getTotalNumberItemsSold();
    getNumberTransactions();
</script>
{% endblock %}
{% extends 'layout.html' %}
{% block content %}
<h4 id="creditDisplay">Credits: {{game.player.credit}}</h4>
<h4 id="fuelDisplay">Current Fuel Level: {{game.player.ship.fuel_level}}</h4>
<h4 id="fuelDisplay">Current Health Level: {{game.player.ship.health_level}}</h4>
<div id="menu">
    <button id="ship" onclick="location.href = 'ship'">Ship</button>
    <button id="travel" onclick="location.href = 'travel'">Travel</button>
    <button id="market" class="active" onclick="location.href = 'market'">Market</button>
    <h2 id="currRegion">Region: {{currRegion.name}}
        ({{currRegion.coordinates.x_position}},
        {{currRegion.coordinates.y_position}})
        Tech Level: {{currRegion.tech_level.name}}
    </h2>
</div>
<div class="menu marketMenu">
    <h2>Market</h2>
    <div class="marketMenuContainer">
        <div class="marketContainer">
            <div class="itemCategories">
                <ul>
                    <li>Food</li>
                    <li>Medicine</li>
                    <li>Weapons</li>
                    <li>Resources</li>
                    <li>Technology</li>
                </ul>
            </div>
            <div class="items">
                <ul id="itemUl">
                    {% for item in currRegion.market %}
                    <li class="item {{loop.index}}"><img
                            src="../static/item-images/item_{{item.name}}.png">{{item.name}}
                        {{item.b_price}}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="bottomContainer">
            <div class="buyInfo">
                <p id="purchaseStatement"></p>
                <!--TODO: add functionality to button-->
                <button type="button" onclick="purchase()">Purchase</button>
            </div>
            <div class="itemDescription">
            </div>
        </div>

    </div>
</div>
<h4>Player Inventory:</h4>
<ul id="playerInv">
    {% for item in game.player.ship.cargo %}
    <li id="itemInv{{loop.index}}"><img src="../static/item-images/item_{{item.name}}.png">{{item.amount}}x
        {{item.name}} <button class="sellButton {{loop.index}}">Sell for
            {{item.s_price}}</button></li>
    {% endfor %}
</ul>
<script type="text/javascript">
    function selectItem(index) {
        showDescription(index);
        showPurchaseStatement(index);
    }
    function showDescription(index) {
        var req = new XMLHttpRequest();
        var result = document.getElementsByClassName("itemDescription");
        var purchaseStatement = document.getElementById("purchaseStatement");
        //only need this section if we're displaying
        req.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                result[0].innerHTML = this.responseText;
                purchaseStatement.innerHTML = "Purchase {{selectedItem.name}}?";
            }
        };
        //this part sends the data over
        req.open('POST', '/market', true);
        req.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
        req.send("selectedIndex=" + index);
    }
    function showPurchaseStatement(index) {
        var req = new XMLHttpRequest();
        var purchaseStatement = document.getElementById("purchaseStatement");
        //only need this section if we're displaying
        req.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                purchaseStatement.innerHTML = this.responseText;
            }
        };
        //this part sends the data over
        req.open('POST', '/market', true);
        req.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
        req.send("statementIndex=" + index);
    }
    function purchase() {
        var req = new XMLHttpRequest();
        var creditDisplay = document.getElementById("creditDisplay");
        //only need this section if we're displaying
        req.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                creditDisplay.innerHTML = this.responseText;
                //TODO: live update inventory when buying?
            }
        };
        //this part sends the data over
        req.open('POST', '/market', true);
        req.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
        req.send("buyIndex=");
    }
    function sellItem(index) {
        var req = new XMLHttpRequest();
        var creditDisplay = document.getElementById("creditDisplay");
        //only need this section if we're displaying
        req.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                creditDisplay.innerHTML = this.responseText;
                //TODO: live update sell
            }
        };
        //this part sends the data over
        req.open('POST', '/market', true);
        req.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
        req.send("sellIndex=" + index);
    }

    // event listener for item selection
    let itemUl = document.getElementById("itemUl");
    itemUl.addEventListener("click", function (event) {
        console.log(event.target);
        if (event.target.classList.contains("item")) {
            selectItem(event.target.classList[1]);
        }
    });

    //event listerner for item sell
    let playerInvUl = document.getElementById("playerInv");
    playerInvUl.addEventListener("click", function (event) {
        console.log(event.target);
        if (event.target.classList.contains("sellButton")) {
            sellItem(event.target.classList[1]);
        }
    }) 
</script>
{% endblock %}